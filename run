#!/bin/bash

# 1. ROOT CHECK
# Silently exit with error code if not root
if [[ $EUID -ne 0 ]]; then
   echo "[ERROR NOT RUNNING]"
   exit 1
fi

# 2. ASK FOR PATH
read -p "Enter config path: " CONFIG_PATH

# 3. VALIDATE FILE
if [[ ! -f "$CONFIG_PATH" ]]; then
    echo "[ERROR NOT RUNNING]"
    exit 1
fi

# 4. PREPARE ENVIRONMENT
FILENAME=$(basename -- "$CONFIG_PATH")
INTERFACE="${FILENAME%.*}"
DEST_PATH="/etc/wireguard/$FILENAME"

# Ensure openresolv is present (Hard check for the specific failure you had)
if ! command -v resolvconf >/dev/null 2>&1; then
    # We can't fix it for you safely in a script, so we fail precisely
    echo "[ERROR NOT RUNNING]"
    exit 1
fi

# Copy config
if ! cp "$CONFIG_PATH" "$DEST_PATH" 2>/dev/null; then
    echo "[ERROR NOT RUNNING]"
    exit 1
fi
chmod 600 "$DEST_PATH"

# 5. RESET & START
# We stop the service AND manually delete the link to clear "File exists" errors
systemctl stop "wg-quick@$INTERFACE" > /dev/null 2>&1
ip link delete "$INTERFACE" > /dev/null 2>&1
systemctl daemon-reload > /dev/null 2>&1

# Attempt start
systemctl start "wg-quick@$INTERFACE" > /dev/null 2>&1

# 6. PRECISE VERIFICATION
# We check three distinct success markers:
# 1. Systemd says active
# 2. Kernel says interface exists
# 3. Interface has an IP address assigned
IS_ACTIVE=$(systemctl is-active "wg-quick@$INTERFACE")
HAS_LINK=$(ip link show "$INTERFACE" 2>/dev/null)
HAS_IP=$(ip -4 addr show "$INTERFACE" 2>/dev/null)

if [[ "$IS_ACTIVE" == "active" ]] && [[ -n "$HAS_LINK" ]] && [[ -n "$HAS_IP" ]]; then
    # Using your specific spelling "SUCESS"
    echo "[SUCESS RUNNING]"
else
    # If it failed, we try to clean up the dead interface so next run is clean
    ip link delete "$INTERFACE" > /dev/null 2>&1
    echo "[ERROR NOT RUNNING]"
fi
