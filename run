#!/bin/bash

# wir3G - VPN Connection Manager
# Dev: oxbv1 | 0xb0rn3
# Repo: https://github.com/0xb0rn3/wir3G.git

VERSION="1.0"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Check root
if [[ $EUID -ne 0 ]]; then
    echo -e "${RED}[!]${NC} Run with sudo"
    exit 1
fi

# Dependency check and install
check_deps() {
    local missing=()
    
    echo -e "${CYAN}[*]${NC} Checking dependencies..."
    
    # Check OpenVPN
    if ! command -v openvpn &>/dev/null; then
        missing+=("openvpn")
    fi
    
    # Check WireGuard
    if ! command -v wg &>/dev/null || ! command -v wg-quick &>/dev/null; then
        missing+=("wireguard-tools")
    fi
    
    # Check resolvconf
    if ! command -v resolvconf &>/dev/null; then
        missing+=("openresolv")
    fi
    
    # Install missing packages
    if [ ${#missing[@]} -gt 0 ]; then
        echo -e "${YELLOW}[!]${NC} Missing: ${missing[*]}"
        echo -e "${CYAN}[*]${NC} Installing dependencies..."
        
        if command -v apt &>/dev/null; then
            apt update -qq
            apt install -y "${missing[@]}"
        elif command -v dnf &>/dev/null; then
            dnf install -y "${missing[@]}"
        elif command -v pacman &>/dev/null; then
            pacman -Sy --noconfirm "${missing[@]}"
        else
            echo -e "${RED}[!]${NC} Package manager not supported"
            echo -e "${YELLOW}[!]${NC} Install manually: ${missing[*]}"
            exit 1
        fi
        
        echo -e "${GREEN}[✓]${NC} Dependencies installed"
    else
        echo -e "${GREEN}[✓]${NC} All dependencies present"
    fi
}

# OpenVPN connection
connect_ovpn() {
    read -p "Config path: " config_path
    
    if [[ ! -f "$config_path" ]]; then
        echo -e "${RED}[!]${NC} Config file not found"
        exit 1
    fi
    
    echo -e "${CYAN}[*]${NC} Connecting via OpenVPN..."
    
    # Kill existing instances
    pkill -9 openvpn 2>/dev/null
    sleep 1
    
    # Start OpenVPN
    openvpn --config "$config_path" --daemon
    sleep 3
    
    # Verify connection
    if pgrep -x openvpn > /dev/null; then
        local pub_ip=$(curl -s ifconfig.me)
        echo -e "${GREEN}[✓]${NC} Connected"
        echo -e "${GREEN}[✓]${NC} Public IP: $pub_ip"
    else
        echo -e "${RED}[!]${NC} Connection failed"
        exit 1
    fi
}

# WireGuard connection
connect_wg() {
    read -p "Config path: " config_path
    
    if [[ ! -f "$config_path" ]]; then
        echo -e "${RED}[!]${NC} Config file not found"
        exit 1
    fi
    
    local filename=$(basename "$config_path")
    local interface="${filename%.*}"
    local dest_path="/etc/wireguard/$filename"
    
    echo -e "${CYAN}[*]${NC} Connecting via WireGuard..."
    
    # Copy config
    cp "$config_path" "$dest_path" 2>/dev/null
    chmod 600 "$dest_path"
    
    # Stop existing connection
    wg-quick down "$interface" 2>/dev/null
    systemctl stop "wg-quick@$interface" 2>/dev/null
    ip link delete "$interface" 2>/dev/null
    sleep 1
    
    # Start WireGuard
    systemctl start "wg-quick@$interface"
    sleep 2
    
    # Verify connection
    local is_active=$(systemctl is-active "wg-quick@$interface")
    local has_link=$(ip link show "$interface" 2>/dev/null)
    local has_ip=$(ip -4 addr show "$interface" 2>/dev/null)
    
    if [[ "$is_active" == "active" ]] && [[ -n "$has_link" ]] && [[ -n "$has_ip" ]]; then
        local pub_ip=$(curl -s ifconfig.me)
        echo -e "${GREEN}[✓]${NC} Connected"
        echo -e "${GREEN}[✓]${NC} Interface: $interface"
        echo -e "${GREEN}[✓]${NC} Public IP: $pub_ip"
    else
        ip link delete "$interface" 2>/dev/null
        echo -e "${RED}[!]${NC} Connection failed"
        exit 1
    fi
}

# Disconnect
disconnect_vpn() {
    echo -e "${CYAN}[*]${NC} Disconnecting..."
    
    # Kill OpenVPN
    pkill -9 openvpn 2>/dev/null
    
    # Stop WireGuard
    for iface in $(wg show interfaces); do
        wg-quick down "$iface" 2>/dev/null
        systemctl stop "wg-quick@$iface" 2>/dev/null
        ip link delete "$iface" 2>/dev/null
    done
    
    sleep 1
    echo -e "${GREEN}[✓]${NC} Disconnected"
}

# Status check
check_status() {
    echo -e "${CYAN}[*]${NC} VPN Status:"
    
    # Check OpenVPN
    if pgrep -x openvpn > /dev/null; then
        echo -e "${GREEN}[✓]${NC} OpenVPN: Running"
    else
        echo -e "${YELLOW}[-]${NC} OpenVPN: Not running"
    fi
    
    # Check WireGuard
    local wg_ifaces=$(wg show interfaces 2>/dev/null)
    if [[ -n "$wg_ifaces" ]]; then
        echo -e "${GREEN}[✓]${NC} WireGuard: Running ($wg_ifaces)"
    else
        echo -e "${YELLOW}[-]${NC} WireGuard: Not running"
    fi
    
    # Show public IP
    local pub_ip=$(curl -s ifconfig.me 2>/dev/null)
    if [[ -n "$pub_ip" ]]; then
        echo -e "${CYAN}[*]${NC} Public IP: $pub_ip"
    fi
}

# Menu
show_menu() {
    echo -e "${CYAN}"
    echo "╔══════════════════════════════╗"
    echo "║         wir3G v$VERSION         ║"
    echo "║   oxbv1 | 0xb0rn3            ║"
    echo "╚══════════════════════════════╝${NC}"
    echo ""
    echo "1) OpenVPN"
    echo "2) WireGuard"
    echo "3) Disconnect"
    echo "4) Status"
    echo "5) Exit"
    echo ""
    read -p "Select: " choice
    
    case $choice in
        1) connect_ovpn ;;
        2) connect_wg ;;
        3) disconnect_vpn ;;
        4) check_status ;;
        5) exit 0 ;;
        *) echo -e "${RED}[!]${NC} Invalid option" && exit 1 ;;
    esac
}

# Main
clear
check_deps
echo ""
show_menu
