#!/usr/bin/env bash

# wir3G - VPN Connection Manager (Enhanced)
# Dev: oxbv1 | 0xb0rn3
# Repo: https://github.com/0xb0rn3/wir3G.git

VERSION="0.2"
CONFIG_FILE="/etc/wir3G/config.json"
CACHE_DIR="/tmp/wir3G_cache"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
NC='\033[0m'

# Check root
if [[ $EUID -ne 0 ]]; then
    echo -e "${RED}[!]${NC} Run with sudo"
    exit 1
fi

# Dependency check and install
check_deps() {
    local missing=()
    
    echo -e "${CYAN}[â]${NC} Checking dependencies..."
    
    # Check OpenVPN
    if ! command -v openvpn &>/dev/null; then
        missing+=("openvpn")
    fi
    
    # Check WireGuard
    if ! command -v wg &>/dev/null || ! command -v wg-quick &>/dev/null; then
        missing+=("wireguard-tools")
    fi
    
    # Check resolvconf
    if ! command -v resolvconf &>/dev/null; then
        missing+=("openresolv")
    fi
    
    # Check Python3 for advanced features
    if ! command -v python3 &>/dev/null; then
        missing+=("python3")
    fi
    
    # Check curl
    if ! command -v curl &>/dev/null; then
        missing+=("curl")
    fi
    
    # Install missing packages
    if [ ${#missing[@]} -gt 0 ]; then
        echo -e "${YELLOW}[!]${NC} Missing: ${missing[*]}"
        echo -e "${CYAN}[â]${NC} Installing dependencies..."
        
        if command -v apt &>/dev/null; then
            apt update -qq &>/dev/null
            apt install -y "${missing[@]}" &>/dev/null
        elif command -v dnf &>/dev/null; then
            dnf install -y "${missing[@]}" &>/dev/null
        elif command -v pacman &>/dev/null; then
            pacman -Sy --noconfirm "${missing[@]}" &>/dev/null
        else
            echo -e "${RED}[!]${NC} Package manager not supported"
            echo -e "${YELLOW}[!]${NC} Install manually: ${missing[*]}"
            exit 1
        fi
        
        echo -e "${GREEN}[â]${NC} Dependencies installed"
    else
        echo -e "${GREEN}[â]${NC} All dependencies present"
    fi
    
    # Check Python packages
    if command -v python3 &>/dev/null; then
        python3 -c "import requests" 2>/dev/null || {
            echo -e "${YELLOW}[!]${NC} Installing Python requests library..."
            python3 -m pip install --quiet requests &>/dev/null || {
                if command -v apt &>/dev/null; then
                    apt install -y python3-requests &>/dev/null
                fi
            }
        }
        
        python3 -c "from bs4 import BeautifulSoup" 2>/dev/null || {
            echo -e "${YELLOW}[!]${NC} Installing Python BeautifulSoup4 library..."
            python3 -m pip install --quiet beautifulsoup4 &>/dev/null || {
                if command -v apt &>/dev/null; then
                    apt install -y python3-bs4 &>/dev/null
                fi
            }
        }
    fi
}

# Initialize config
init_config() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        mkdir -p /etc/wir3G
        echo '{"sessions":[]}' > "$CONFIG_FILE"
        chmod 600 "$CONFIG_FILE"
    fi
}

# Save session
save_session() {
    local vpn_type="$1"
    local config_path="$2"
    local username="$3"
    local password="$4"
    local timestamp=$(date +%s)
    
    init_config
    
    # Escape special characters for JSON
    username=$(echo "$username" | sed 's/\\/\\\\/g; s/"/\\"/g')
    password=$(echo "$password" | sed 's/\\/\\\\/g; s/"/\\"/g')
    config_path=$(echo "$config_path" | sed 's/\\/\\\\/g; s/"/\\"/g')
    
    # Read existing sessions
    local sessions=$(grep -o '"sessions":\[.*\]' "$CONFIG_FILE" 2>/dev/null | sed 's/"sessions"://' || echo "[]")
    
    # Create new session entry
    local new_entry="{\"type\":\"$vpn_type\",\"config\":\"$config_path\",\"username\":\"$username\",\"password\":\"$password\",\"timestamp\":$timestamp}"
    
    # Add to sessions array
    if [[ "$sessions" == "[]" ]]; then
        sessions="[$new_entry]"
    else
        sessions="${sessions%]}"
        if [[ "$sessions" == "[" ]]; then
            sessions="[$new_entry]"
        else
            sessions="${sessions},$new_entry]"
        fi
    fi
    
    # Write back
    echo "{\"sessions\":$sessions}" > "$CONFIG_FILE"
    chmod 600 "$CONFIG_FILE"
}

# Get last session
get_last_session() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        echo ""
        return
    fi
    
    local sessions=$(cat "$CONFIG_FILE" | grep -o '"sessions":\[.*\]')
    if [[ "$sessions" == *"[]"* ]] || [[ -z "$sessions" ]]; then
        echo ""
        return
    fi
    
    local last=$(echo "$sessions" | grep -o '{[^}]*}' | tail -n1)
    echo "$last"
}

# Parse session field
get_session_field() {
    local session="$1"
    local field="$2"
    echo "$session" | grep -o "\"$field\":\"[^\"]*\"" | cut -d'"' -f4
}

get_session_timestamp() {
    local session="$1"
    echo "$session" | grep -o '"timestamp":[0-9]*' | cut -d':' -f2
}

# Check if should reconnect
check_reconnect() {
    local ovpn_running=$(pgrep -x openvpn > /dev/null && echo "yes" || echo "no")
    local wg_running=$(wg show interfaces 2>/dev/null)
    
    if [[ "$ovpn_running" == "yes" ]] || [[ -n "$wg_running" ]]; then
        echo -e "${GREEN}âââââââââââââââââââââââââââââââââââââââ${NC}"
        echo -e "${GREEN}â  Active VPN Session Detected        â${NC}"
        echo -e "${GREEN}âââââââââââââââââââââââââââââââââââââââ${NC}"
        if [[ "$ovpn_running" == "yes" ]]; then
            echo -e "  ${GREEN}â${NC} OpenVPN: Running"
        fi
        if [[ -n "$wg_running" ]]; then
            echo -e "  ${GREEN}â${NC} WireGuard: $wg_running"
        fi
        local pub_ip=$(curl -s ifconfig.me 2>/dev/null)
        if [[ -n "$pub_ip" ]]; then
            echo -e "  ${CYAN}â${NC} Public IP: ${YELLOW}$pub_ip${NC}"
        fi
        echo ""
        return
    fi
    
    local last_session=$(get_last_session)
    
    if [[ -z "$last_session" ]]; then
        return
    fi
    
    local timestamp=$(get_session_timestamp "$last_session")
    local vpn_type=$(get_session_field "$last_session" "type")
    local config_path=$(get_session_field "$last_session" "config")
    local current_time=$(date +%s)
    local time_diff=$((current_time - timestamp))
    
    if [[ $time_diff -lt 86400 ]]; then
        local hours=$((time_diff / 3600))
        echo -e "${YELLOW}[?]${NC} Last session: $vpn_type ($hours hours ago)"
        read -p "Reconnect? [y/N]: " reconnect
        
        if [[ "$reconnect" =~ ^[Yy]$ ]]; then
            if [[ "$vpn_type" == "openvpn" ]]; then
                local username=$(get_session_field "$last_session" "username")
                local password=$(get_session_field "$last_session" "password")
                reconnect_ovpn "$config_path" "$username" "$password"
            else
                reconnect_wg "$config_path"
            fi
            exit 0
        fi
        echo ""
    fi
}

# Reconnect OpenVPN
reconnect_ovpn() {
    local config_path="$1"
    local username="$2"
    local password="$3"
    
    if [[ ! -f "$config_path" ]]; then
        echo -e "${RED}[!]${NC} Previous config not found"
        return
    fi
    
    echo -e "${CYAN}[â]${NC} Reconnecting via OpenVPN..."
    
    pkill -9 openvpn 2>/dev/null
    sleep 1
    
    local log_file="/tmp/ovpn_reconnect_$$.log"
    
    if [[ -n "$username" ]] && [[ -n "$password" ]]; then
        local auth_file="/tmp/ovpn_auth_$$"
        echo "$username" > "$auth_file"
        echo "$password" >> "$auth_file"
        chmod 600 "$auth_file"
        
        openvpn --config "$config_path" --auth-user-pass "$auth_file" --daemon --log "$log_file"
        rm -f "$auth_file"
    else
        openvpn --config "$config_path" --daemon --log "$log_file"
    fi
    
    echo -e "${CYAN}[â]${NC} Waiting for connection..."
    local success="no"
    local attempts=0
    
    while [[ $attempts -lt 15 ]]; do
        sleep 1
        ((attempts++))
        
        if [[ -f "$log_file" ]]; then
            if grep -q "Initialization Sequence Completed" "$log_file" 2>/dev/null; then
                success="yes"
                break
            fi
            
            if grep -q "AUTH_FAILED\|auth-failure" "$log_file" 2>/dev/null; then
                echo -e "${RED}[!]${NC} Authentication failed"
                pkill -9 openvpn 2>/dev/null
                rm -f "$log_file"
                return
            fi
        fi
    done
    
    if [[ "$success" == "yes" ]] && pgrep -x openvpn > /dev/null; then
        local pub_ip=$(curl -s ifconfig.me 2>/dev/null)
        echo -e "${GREEN}[â]${NC} Connected"
        if [[ -n "$pub_ip" ]]; then
            echo -e "${GREEN}[â]${NC} Public IP: $pub_ip"
        fi
    else
        echo -e "${RED}[!]${NC} Connection failed"
        pkill -9 openvpn 2>/dev/null
    fi
    
    rm -f "$log_file"
}

# Reconnect WireGuard
reconnect_wg() {
    local config_path="$1"
    
    if [[ ! -f "$config_path" ]]; then
        echo -e "${RED}[!]${NC} Previous config not found"
        return
    fi
    
    local filename=$(basename "$config_path")
    local interface="${filename%.*}"
    
    echo -e "${CYAN}[â]${NC} Reconnecting via WireGuard..."
    
    wg-quick down "$interface" 2>/dev/null
    sleep 1
    
    if wg-quick up "$interface" &>/dev/null; then
        sleep 2
        local pub_ip=$(curl -s ifconfig.me 2>/dev/null)
        echo -e "${GREEN}[â]${NC} Connected"
        echo -e "${GREEN}[â]${NC} Interface: $interface"
        if [[ -n "$pub_ip" ]]; then
            echo -e "${GREEN}[â]${NC} Public IP: $pub_ip"
        fi
    else
        echo -e "${RED}[!]${NC} Connection failed"
    fi
}

# OpenVPN connection
connect_ovpn() {
    read -p "Config path: " config_path
    
    if [[ ! -f "$config_path" ]]; then
        echo -e "${RED}[!]${NC} Config file not found"
        exit 1
    fi
    
    echo -e "${CYAN}[â]${NC} Connecting via OpenVPN..."
    
    pkill -9 openvpn 2>/dev/null
    sleep 1
    
    local log_file="/tmp/ovpn_$$.log"
    local username=""
    local password=""
    
    openvpn --config "$config_path" --daemon --log "$log_file" 2>&1
    
    local attempts=0
    local needs_auth="no"
    local success="no"
    
    echo -e "${CYAN}[â]${NC} Waiting for connection..."
    
    while [[ $attempts -lt 20 ]]; do
        sleep 1
        ((attempts++))
        
        if [[ -f "$log_file" ]]; then
            if grep -q "AUTH.*username.*password\|auth-user-pass" "$log_file" 2>/dev/null && [[ "$needs_auth" == "no" ]]; then
                needs_auth="yes"
                
                pkill -9 openvpn 2>/dev/null
                sleep 1
                
                local last_session=$(get_last_session)
                if [[ -n "$last_session" ]]; then
                    local last_config=$(get_session_field "$last_session" "config")
                    if [[ "$last_config" == "$config_path" ]]; then
                        username=$(get_session_field "$last_session" "username")
                        password=$(get_session_field "$last_session" "password")
                    fi
                fi
                
                if [[ -z "$username" ]]; then
                    echo ""
                    read -p "Username: " username
                    read -s -p "Password: " password
                    echo ""
                else
                    echo -e "${CYAN}[â]${NC} Using saved credentials for: $username"
                fi
                
                local auth_file="/tmp/ovpn_auth_$$"
                echo "$username" > "$auth_file"
                echo "$password" >> "$auth_file"
                chmod 600 "$auth_file"
                
                > "$log_file"
                openvpn --config "$config_path" --auth-user-pass "$auth_file" --daemon --log "$log_file"
                rm -f "$auth_file"
                
                attempts=0
                continue
            fi
            
            if grep -q "Initialization Sequence Completed" "$log_file" 2>/dev/null; then
                success="yes"
                break
            fi
            
            if grep -q "AUTH_FAILED\|auth-failure\|authentication failed" "$log_file" 2>/dev/null; then
                echo -e "${RED}[!]${NC} Authentication failed"
                pkill -9 openvpn 2>/dev/null
                rm -f "$log_file"
                exit 1
            fi
            
            if grep -q "Exiting due to fatal error" "$log_file" 2>/dev/null; then
                echo -e "${RED}[!]${NC} Connection failed"
                echo -e "${YELLOW}[!]${NC} Check: cat $log_file"
                pkill -9 openvpn 2>/dev/null
                exit 1
            fi
        fi
    done
    
    if [[ "$success" == "yes" ]] && pgrep -x openvpn > /dev/null; then
        local pub_ip=$(curl -s ifconfig.me 2>/dev/null)
        echo -e "${GREEN}[â]${NC} Connected"
        if [[ -n "$pub_ip" ]]; then
            echo -e "${GREEN}[â]${NC} Public IP: $pub_ip"
        fi
        
        save_session "openvpn" "$config_path" "$username" "$password"
    else
        echo -e "${RED}[!]${NC} Connection timeout"
        if [[ -f "$log_file" ]]; then
            echo -e "${YELLOW}[!]${NC} Check: cat $log_file"
        fi
        pkill -9 openvpn 2>/dev/null
        exit 1
    fi
    
    rm -f "$log_file"
}

# WireGuard connection
connect_wg() {
    read -p "Config path: " config_path
    
    if [[ ! -f "$config_path" ]]; then
        echo -e "${RED}[!]${NC} Config file not found"
        exit 1
    fi
    
    local filename=$(basename "$config_path")
    local interface="${filename%.*}"
    
    if [[ ! "$filename" =~ \.conf$ ]]; then
        filename="${interface}.conf"
    fi
    
    local dest_path="/etc/wireguard/$filename"
    
    echo -e "${CYAN}[â]${NC} Connecting via WireGuard..."
    
    mkdir -p /etc/wireguard
    
    if ! cp "$config_path" "$dest_path" 2>/dev/null; then
        echo -e "${RED}[!]${NC} Failed to copy config"
        exit 1
    fi
    chmod 600 "$dest_path"
    
    wg-quick down "$interface" 2>/dev/null
    systemctl stop "wg-quick@$interface" 2>/dev/null
    ip link delete "$interface" 2>/dev/null
    sleep 1
    
    if wg-quick up "$interface" 2>&1 | grep -q "error\|failed"; then
        echo -e "${RED}[!]${NC} WireGuard startup failed"
        echo -e "${YELLOW}[!]${NC} Check: journalctl -xeu wg-quick@$interface"
        exit 1
    fi
    
    sleep 2
    
    local has_link=$(ip link show "$interface" 2>/dev/null)
    local has_ip=$(ip -4 addr show "$interface" 2>/dev/null)
    
    if [[ -n "$has_link" ]] && [[ -n "$has_ip" ]]; then
        local pub_ip=$(curl -s ifconfig.me 2>/dev/null)
        echo -e "${GREEN}[â]${NC} Connected"
        echo -e "${GREEN}[â]${NC} Interface: $interface"
        if [[ -n "$pub_ip" ]]; then
            echo -e "${GREEN}[â]${NC} Public IP: $pub_ip"
        fi
        
        save_session "wireguard" "$config_path" "" ""
    else
        wg-quick down "$interface" 2>/dev/null
        echo -e "${RED}[!]${NC} Connection failed"
        exit 1
    fi
}

# Disconnect
disconnect_vpn() {
    echo ""
    echo -e "${CYAN}[â]${NC} Disconnecting VPN..."
    
    if pgrep -x openvpn > /dev/null; then
        pkill -9 openvpn 2>/dev/null
        echo -e "  ${GREEN}â${NC} OpenVPN stopped"
    fi
    
    local wg_stopped=0
    for iface in $(wg show interfaces 2>/dev/null); do
        wg-quick down "$iface" 2>/dev/null
        systemctl stop "wg-quick@$iface" 2>/dev/null
        ip link delete "$iface" 2>/dev/null
        echo -e "  ${GREEN}â${NC} WireGuard ($iface) stopped"
        wg_stopped=1
    done
    
    sleep 1
    
    if ! pgrep -x openvpn > /dev/null && [[ -z "$(wg show interfaces 2>/dev/null)" ]]; then
        echo ""
        echo -e "${GREEN}[â]${NC} All VPN connections closed"
    else
        echo -e "${YELLOW}[!]${NC} Some connections may still be active"
    fi
    echo ""
}

# Status check
check_status() {
    echo ""
    echo -e "${CYAN}âââââââââââââââââââââââââââââââââââââââ${NC}"
    echo -e "${CYAN}â         VPN Status Check            â${NC}"
    echo -e "${CYAN}âââââââââââââââââââââââââââââââââââââââ${NC}"
    echo ""
    
    if pgrep -x openvpn > /dev/null; then
        echo -e "  ${GREEN}â${NC} OpenVPN: ${GREEN}Running${NC}"
    else
        echo -e "  ${YELLOW}â${NC} OpenVPN: ${YELLOW}Not running${NC}"
    fi
    
    local wg_ifaces=$(wg show interfaces 2>/dev/null)
    if [[ -n "$wg_ifaces" ]]; then
        echo -e "  ${GREEN}â${NC} WireGuard: ${GREEN}Running${NC} ($wg_ifaces)"
    else
        echo -e "  ${YELLOW}â${NC} WireGuard: ${YELLOW}Not running${NC}"
    fi
    
    echo ""
    local pub_ip=$(curl -s ifconfig.me 2>/dev/null)
    if [[ -n "$pub_ip" ]]; then
        echo -e "  ${CYAN}â${NC} Public IP: ${YELLOW}$pub_ip${NC}"
    else
        echo -e "  ${RED}â${NC} Public IP: ${RED}Unable to fetch${NC}"
    fi
    echo ""
}

# Enhanced VPNGate with server downloading
fetch_vpngate_advanced() {
    clear
    echo -e "${CYAN}"
    echo "âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ"
    echo "â                    VPNGate Free Servers                           â"
    echo "âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ${NC}"
    echo ""
    echo -e "  ${GREEN}1${NC}) Browse & Connect to Single Server (Quick)"
    echo -e "  ${GREEN}2${NC}) Download & Save Multiple Servers (Automated)"
    echo -e "  ${GREEN}3${NC}) Download VPNBook Servers (Alternative Provider)"
    echo -e "  ${YELLOW}4${NC}) Back to Main Menu"
    echo ""
    read -p "  â " vpngate_choice
    
    case $vpngate_choice in
        1) fetch_vpngate_single ;;
        2) download_vpngate_bulk ;;
        3) download_vpnbook_bulk ;;
        4) return ;;
        *) echo -e "${RED}[!]${NC} Invalid option" && sleep 1 && fetch_vpngate_advanced ;;
    esac
}

# Original single server browser
fetch_vpngate_single() {
    echo ""
    echo -e "${CYAN}[â]${NC} Fetching VPNGate servers..."
    
    local csv_file="/tmp/vpngate_$$.csv"
    
    if ! curl -s "https://www.vpngate.net/api/iphone/" -o "$csv_file" 2>/dev/null; then
        echo -e "${RED}[!]${NC} Failed to fetch server list"
        return 1
    fi
    
    tail -n +3 "$csv_file" > "${csv_file}.clean"
    
    echo -e "${GREEN}[â]${NC} Server list downloaded"
    echo ""
    
    echo -e "${CYAN}âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ${NC}"
    echo -e "${CYAN}â                    Available VPNGate Servers                       â${NC}"
    echo -e "${CYAN}âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ${NC}"
    echo ""
    
    local count=1
    local -a servers
    
    while IFS=',' read -r hostname ip score ping speed country_long country_short sessions uptime users traffic logtype operator message config_base64; do
        if [[ -n "$hostname" ]] && [[ "$hostname" != "#HostName" ]]; then
            local speed_mbps=$((speed / 1000000))
            
            printf "  ${GREEN}%2d${NC}) %-20s ${YELLOW}%-15s${NC} ${CYAN}%-3s${NC} %4d Mbps  Sessions: %d\n" \
                "$count" "$country_long" "$ip" "$country_short" "$speed_mbps" "$sessions"
            
            servers[$count]="$hostname,$ip,$country_short,$config_base64"
            ((count++))
            
            if [[ $count -gt 20 ]]; then
                break
            fi
        fi
    done < "${csv_file}.clean"
    
    echo ""
    read -p "Select server (1-$((count-1))) or 0 to cancel: " selection
    
    if [[ "$selection" -eq 0 ]] || [[ -z "${servers[$selection]}" ]]; then
        rm -f "$csv_file" "${csv_file}.clean"
        return
    fi
    
    IFS=',' read -r hostname ip country config_base64 <<< "${servers[$selection]}"
    
    local config_file="/tmp/vpngate_${country}_${hostname}.ovpn"
    echo "$config_base64" | base64 -d > "$config_file" 2>/dev/null
    
    if [[ ! -f "$config_file" ]] || [[ ! -s "$config_file" ]]; then
        echo -e "${RED}[!]${NC} Failed to decode config"
        rm -f "$csv_file" "${csv_file}.clean"
        return
    fi
    
    echo -e "${GREEN}[â]${NC} Config saved: $config_file"
    echo -e "${CYAN}[â]${NC} Hostname: $hostname"
    echo -e "${CYAN}[â]${NC} IP: $ip"
    echo -e "${CYAN}[â]${NC} Country: $country"
    echo ""
    
    read -p "Connect now? [y/N]: " connect_now
    
    if [[ "$connect_now" =~ ^[Yy]$ ]]; then
        echo ""
        echo -e "${CYAN}[â]${NC} Connecting via OpenVPN..."
        
        # Add cipher support to config file
        echo "data-ciphers AES-256-GCM:AES-128-GCM:AES-128-CBC:CHACHA20-POLY1305" >> "$config_file"
        
        pkill -9 openvpn 2>/dev/null
        sleep 1
        
        local log_file="/tmp/ovpn_vpngate_$$.log"
        openvpn --config "$config_file" --daemon --log "$log_file" 2>&1
        
        echo -e "${CYAN}[â]${NC} Waiting for connection..."
        local success="no"
        local attempts=0
        local retry_count=0
        
        while [[ $attempts -lt 20 ]]; do
            sleep 1
            ((attempts++))
            
            if [[ -f "$log_file" ]]; then
                # Check for success
                if grep -q "Initialization Sequence Completed" "$log_file" 2>/dev/null; then
                    success="yes"
                    break
                fi
                
                # Check for auth failure
                if grep -q "AUTH_FAILED\|auth-failure" "$log_file" 2>/dev/null; then
                    echo -e "${YELLOW}[!]${NC} Server requires authentication (trying next server recommended)"
                    pkill -9 openvpn 2>/dev/null
                    break
                fi
                
                # Check for other errors
                if grep -q "Connection refused\|connect failed\|Connection reset" "$log_file" 2>/dev/null; then
                    if [[ $retry_count -lt 1 ]]; then
                        echo -e "${YELLOW}[!]${NC} Connection issue, retrying..."
                        pkill -9 openvpn 2>/dev/null
                        sleep 2
                        > "$log_file"
                        openvpn --config "$config_file" --daemon --log "$log_file" 2>&1
                        ((retry_count++))
                        attempts=0
                        continue
                    else
                        echo -e "${YELLOW}[!]${NC} Server unreachable"
                        pkill -9 openvpn 2>/dev/null
                        break
                    fi
                fi
            fi
        done
        
        if [[ "$success" == "yes" ]] && pgrep -x openvpn > /dev/null; then
            local pub_ip=$(curl -s ifconfig.me 2>/dev/null)
            echo -e "${GREEN}[â]${NC} Connected to VPNGate!"
            if [[ -n "$pub_ip" ]]; then
                echo -e "${GREEN}[â]${NC} Public IP: $pub_ip"
            fi
            save_session "openvpn" "$config_file" "" ""
        else
            echo -e "${RED}[!]${NC} Connection failed"
            echo -e "${YELLOW}[!]${NC} Tip: Try a different server (Japanese servers usually work best)"
            pkill -9 openvpn 2>/dev/null
            
            echo ""
            read -p "Try another server? [y/N]: " try_another
            if [[ "$try_another" =~ ^[Yy]$ ]]; then
                rm -f "$log_file" "$csv_file" "${csv_file}.clean"
                fetch_vpngate_single
                return
            fi
        fi
        
        rm -f "$log_file"
    fi
    
    rm -f "$csv_file" "${csv_file}.clean"
    echo ""
    read -p "Press Enter to continue..."
}

# Bulk VPNGate downloader
download_vpngate_bulk() {
    echo ""
    echo -e "${CYAN}âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ${NC}"
    echo -e "${CYAN}â           VPNGate Bulk Server Downloader                          â${NC}"
    echo -e "${CYAN}âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ${NC}"
    echo ""
    
    read -p "Save location [/tmp/vpngate_configs]: " save_location
    save_location=${save_location:-/tmp/vpngate_configs}
    
    mkdir -p "$save_location"
    
    echo ""
    echo -e "${CYAN}[â]${NC} Downloading VPNGate server list..."
    
    # Create Python downloader script
    cat > /tmp/vpngate_downloader.py << 'PYTHON_SCRIPT'
import os
import csv
import base64
import requests
import sys

def download_vpngate(output_folder):
    url = "http://www.vpngate.net/api/iphone/"
    
    try:
        response = requests.get(url, timeout=10)
        response.encoding = 'utf-8'
        
        if response.status_code != 200:
            print("Error downloading VPNGate CSV")
            return 0
            
        csv_content = response.text
        csv_lines = csv_content.splitlines()[1:]
        reader = csv.DictReader(csv_lines)
        
        os.makedirs(output_folder, exist_ok=True)
        
        # Create auth file
        auth_file_path = os.path.join(output_folder, "vpngate.txt")
        with open(auth_file_path, 'w') as f:
            f.write("vpn\nvpn\n")
        os.chmod(auth_file_path, 0o600)
        
        servers = []
        total = 0
        created = 0
        
        for row in reader:
            hostname = row.get('#HostName')
            config_data = row.get('OpenVPN_ConfigData_Base64')
            country = row.get('CountryShort', 'XX')
            speed = int(row.get('Speed', '0'))
            
            if not hostname or not config_data or '*' in hostname:
                continue
                
            total += 1
            servers.append({
                'hostname': hostname,
                'config': config_data,
                'country': country,
                'speed': speed
            })
        
        # Sort by speed
        servers.sort(key=lambda x: x['speed'], reverse=True)
        
        print(f"\n{'='*70}")
        print(f"{'Country':<15} {'Hostname':<30} {'Speed (Mbps)':<15}")
        print(f"{'='*70}")
        
        for idx, server in enumerate(servers[:50], 1):  # Top 50 servers
            filename = os.path.join(output_folder, f"{server['hostname']}.ovpn")
            
            if os.path.exists(filename):
                continue
                
            try:
                ovpn_data = base64.b64decode(server['config'])
                with open(filename, 'wb') as f:
                    f.write(ovpn_data)
                    
                # Add auth and cipher options
                with open(filename, 'a') as f:
                    f.write(f"\nauth-user-pass {os.path.abspath(auth_file_path)}\n")
                    f.write("data-ciphers AES-256-GCM:AES-128-GCM:AES-128-CBC:CHACHA20-POLY1305\n")
                
                speed_mbps = server['speed'] // 1000000
                print(f"{server['country']:<15} {server['hostname']:<30} {speed_mbps:<15}")
                created += 1
                
            except Exception as e:
                continue
        
        print(f"{'='*70}")
        print(f"\nTotal servers found: {total}")
        print(f"Configurations created: {created}")
        print(f"Save location: {output_folder}")
        print(f"Auth file: {auth_file_path}")
        
        return created
        
    except Exception as e:
        print(f"Error: {e}")
        return 0

if __name__ == "__main__":
    output = sys.argv[1] if len(sys.argv) > 1 else "/tmp/vpngate_configs"
    download_vpngate(output)
PYTHON_SCRIPT
    
    python3 /tmp/vpngate_downloader.py "$save_location"
    local result=$?
    
    rm -f /tmp/vpngate_downloader.py
    
    echo ""
    echo -e "${GREEN}[â]${NC} Download complete!"
    echo ""
    
    read -p "Keep these configurations? [y/N]: " keep_configs
    
    if [[ ! "$keep_configs" =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}[â]${NC} Removing downloaded configurations..."
        rm -rf "$save_location"
        echo -e "${GREEN}[â]${NC} Cleaned up"
    else
        echo -e "${GREEN}[â]${NC} Configurations saved to: $save_location"
        echo ""
        read -p "Test a configuration now? [y/N]: " test_now
        
        if [[ "$test_now" =~ ^[Yy]$ ]]; then
            local first_config=$(find "$save_location" -name "*.ovpn" -type f | head -n1)
            if [[ -n "$first_config" ]]; then
                echo ""
                echo -e "${CYAN}[â]${NC} Testing: $(basename "$first_config")"
                echo -e "${CYAN}[â]${NC} Connecting..."
                
                pkill -9 openvpn 2>/dev/null
                sleep 1
                
                local log_file="/tmp/ovpn_test_$$.log"
                openvpn --config "$first_config" --daemon --log "$log_file"
                
                echo -e "${CYAN}[â]${NC} Waiting for connection..."
                local success="no"
                local attempts=0
                
                while [[ $attempts -lt 15 ]]; do
                    sleep 1
                    ((attempts++))
                    
                    if [[ -f "$log_file" ]] && grep -q "Initialization Sequence Completed" "$log_file" 2>/dev/null; then
                        success="yes"
                        break
                    fi
                done
                
                if [[ "$success" == "yes" ]] && pgrep -x openvpn > /dev/null; then
                    local pub_ip=$(curl -s ifconfig.me 2>/dev/null)
                    echo -e "${GREEN}[â]${NC} Connected successfully!"
                    if [[ -n "$pub_ip" ]]; then
                        echo -e "${GREEN}[â]${NC} Public IP: $pub_ip"
                    fi
                    save_session "openvpn" "$first_config" "" ""
                else
                    echo -e "${YELLOW}[!]${NC} Connection test failed (this is normal for free servers)"
                    pkill -9 openvpn 2>/dev/null
                fi
                
                rm -f "$log_file"
            fi
        fi
    fi
    
    echo ""
    read -p "Press Enter to continue..."
}

# Bulk VPNBook downloader
download_vpnbook_bulk() {
    echo ""
    echo -e "${MAGENTA}âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ${NC}"
    echo -e "${MAGENTA}â           VPNBook Server Downloader                               â${NC}"
    echo -e "${MAGENTA}âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ${NC}"
    echo ""
    
    read -p "Save location [/tmp/vpnbook_configs]: " save_location
    save_location=${save_location:-/tmp/vpnbook_configs}
    
    mkdir -p "$save_location"
    
    echo ""
    echo -e "${CYAN}[â]${NC} Fetching VPNBook password from website..."
    
    # Create Python downloader script
    cat > /tmp/vpnbook_downloader.py << 'PYTHON_SCRIPT'
import os
import requests
import zipfile
import shutil
import sys
from bs4 import BeautifulSoup

def download_vpnbook(output_folder):
    url = "https://www.vpnbook.com/freevpn"
    temp_dir = os.path.join(output_folder, "temp")
    
    try:
        # Get password from website
        print("Fetching current password...")
        response = requests.get(url, timeout=10)
        soup = BeautifulSoup(response.text, 'html.parser')
        
        # Find password
        password = "e83zu76"  # Default
        password_elem = soup.find('kbd', class_='password')
        if password_elem:
            password = password_elem.text.strip()
        
        print(f"Current password: {password}")
        
        # Find zip links
        zip_links = [
            f"https://www.vpnbook.com{link.get('href')}"
            for link in soup.find_all('a', href=True)
            if link.get('href').startswith("/free-openvpn-account/") and link.get('href').endswith(".zip")
        ]
        
        print(f"Found {len(zip_links)} server packages")
        
        os.makedirs(output_folder, exist_ok=True)
        os.makedirs(temp_dir, exist_ok=True)
        
        # Download and extract
        for zip_link in zip_links:
            zip_name = os.path.basename(zip_link)
            print(f"Downloading {zip_name}...")
            
            zip_path = os.path.join(temp_dir, zip_name)
            response = requests.get(zip_link, stream=True, timeout=10)
            
            if response.status_code == 200:
                with open(zip_path, 'wb') as f:
                    shutil.copyfileobj(response.raw, f)
                    
                with zipfile.ZipFile(zip_path, 'r') as zip_ref:
                    zip_ref.extractall(temp_dir)
        
        # Find .ovpn files
        ovpn_files = []
        for root, _, files in os.walk(temp_dir):
            for file in files:
                if file.endswith('.ovpn'):
                    ovpn_files.append(os.path.join(root, file))
        
        print(f"\nFound {len(ovpn_files)} configuration files")
        
        # Create auth file
        auth_file = os.path.join(output_folder, "vpnbook.txt")
        with open(auth_file, 'w') as f:
            f.write(f"vpnbook\n{password}\n")
        os.chmod(auth_file, 0o600)
        
        print(f"\n{'='*70}")
        print(f"{'Configuration File':<40} {'Location':<30}")
        print(f"{'='*70}")
        
        # Move and configure
        for ovpn in ovpn_files:
            dest = os.path.join(output_folder, os.path.basename(ovpn))
            shutil.move(ovpn, dest)
            
            # Add auth
            with open(dest, 'a') as f:
                f.write(f"\nauth-user-pass {os.path.abspath(auth_file)}\n")
                f.write("data-ciphers AES-256-GCM:AES-128-GCM:AES-128-CBC:CHACHA20-POLY1305\n")
            
            print(f"{os.path.basename(ovpn):<40} {dest:<30}")
        
        print(f"{'='*70}")
        print(f"\nTotal configurations: {len(ovpn_files)}")
        print(f"Save location: {output_folder}")
        print(f"Auth file: {auth_file}")
        print(f"Username: vpnbook")
        print(f"Password: {password}")
        
        # Cleanup
        shutil.rmtree(temp_dir)
        
        return len(ovpn_files)
        
    except Exception as e:
        print(f"Error: {e}")
        if os.path.exists(temp_dir):
            shutil.rmtree(temp_dir)
        return 0

if __name__ == "__main__":
    output = sys.argv[1] if len(sys.argv) > 1 else "/tmp/vpnbook_configs"
    download_vpnbook(output)
PYTHON_SCRIPT
    
    python3 /tmp/vpnbook_downloader.py "$save_location"
    local result=$?
    
    rm -f /tmp/vpnbook_downloader.py
    
    echo ""
    echo -e "${GREEN}[â]${NC} Download complete!"
    echo ""
    echo -e "${YELLOW}[!]${NC} Note: VPNBook password changes periodically"
    echo -e "${YELLOW}[!]${NC} Visit https://www.vpnbook.com/freevpn to get the latest password"
    echo ""
    
    read -p "Keep these configurations? [y/N]: " keep_configs
    
    if [[ ! "$keep_configs" =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}[â]${NC} Removing downloaded configurations..."
        rm -rf "$save_location"
        echo -e "${GREEN}[â]${NC} Cleaned up"
    else
        echo -e "${GREEN}[â]${NC} Configurations saved to: $save_location"
        echo ""
        read -p "Test a configuration now? [y/N]: " test_now
        
        if [[ "$test_now" =~ ^[Yy]$ ]]; then
            local first_config=$(find "$save_location" -name "*.ovpn" -type f | head -n1)
            if [[ -n "$first_config" ]]; then
                echo ""
                echo -e "${CYAN}[â]${NC} Testing: $(basename "$first_config")"
                echo -e "${CYAN}[â]${NC} Connecting..."
                
                pkill -9 openvpn 2>/dev/null
                sleep 1
                
                local log_file="/tmp/ovpn_test_$$.log"
                openvpn --config "$first_config" --daemon --log "$log_file"
                
                echo -e "${CYAN}[â]${NC} Waiting for connection..."
                local success="no"
                local attempts=0
                
                while [[ $attempts -lt 15 ]]; do
                    sleep 1
                    ((attempts++))
                    
                    if [[ -f "$log_file" ]] && grep -q "Initialization Sequence Completed" "$log_file" 2>/dev/null; then
                        success="yes"
                        break
                    fi
                done
                
                if [[ "$success" == "yes" ]] && pgrep -x openvpn > /dev/null; then
                    local pub_ip=$(curl -s ifconfig.me 2>/dev/null)
                    echo -e "${GREEN}[â]${NC} Connected successfully!"
                    if [[ -n "$pub_ip" ]]; then
                        echo -e "${GREEN}[â]${NC} Public IP: $pub_ip"
                    fi
                    save_session "openvpn" "$first_config" "" ""
                else
                    echo -e "${YELLOW}[!]${NC} Connection test failed"
                    echo -e "${YELLOW}[!]${NC} Try another server or check the password"
                    pkill -9 openvpn 2>/dev/null
                fi
                
                rm -f "$log_file"
            fi
        fi
    fi
    
    echo ""
    read -p "Press Enter to continue..."
}

# System-wide installation
install_system() {
    echo ""
    echo -e "${CYAN}âââââââââââââââââââââââââââââââââââââââ${NC}"
    echo -e "${CYAN}â      System Installation            â${NC}"
    echo -e "${CYAN}âââââââââââââââââââââââââââââââââââââââ${NC}"
    echo ""
    echo -e "${YELLOW}[!]${NC} This will install wir3G to /usr/local/bin/"
    read -p "Continue? [y/N]: " confirm
    
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        return
    fi
    
    local script_path="$(readlink -f "$0")"
    
    if cp "$script_path" /usr/local/bin/wir3G 2>/dev/null; then
        chmod +x /usr/local/bin/wir3G
        echo -e "${GREEN}[â]${NC} Installed to /usr/local/bin/wir3G"
        echo -e "${GREEN}[â]${NC} You can now run: ${CYAN}sudo wir3G${NC}"
        echo ""
    else
        echo -e "${RED}[!]${NC} Installation failed"
        echo -e "${YELLOW}[!]${NC} Try: sudo cp $script_path /usr/local/bin/wir3G"
    fi
}

# Config builder
build_config() {
    clear
    echo -e "${CYAN}"
    echo "âââââââââââââââââââââââââââââââââââââââ"
    echo "        CONFIG BUILDER"
    echo "âââââââââââââââââââââââââââââââââââââââ${NC}"
    echo ""
    echo "1) WireGuard Config"
    echo "2) OpenVPN Config"
    echo "3) Back"
    echo ""
    read -p "Select: " build_choice
    
    case $build_choice in
        1) build_wg_config ;;
        2) build_ovpn_config ;;
        3) return ;;
        *) echo -e "${RED}[!]${NC} Invalid option" && return ;;
    esac
}

# Build WireGuard config
build_wg_config() {
    echo ""
    echo -e "${CYAN}[*]${NC} WireGuard Config Builder"
    echo ""
    
    read -p "Private Key: " private_key
    read -p "Address (e.g., 10.0.0.2/24): " address
    read -p "DNS (e.g., 1.1.1.1): " dns
    echo ""
    read -p "Peer Public Key: " peer_public
    read -p "Endpoint (e.g., vpn.server.com:51820): " endpoint
    read -p "Allowed IPs (default: 0.0.0.0/0): " allowed_ips
    allowed_ips=${allowed_ips:-0.0.0.0/0}
    
    local config_name="wir3g_$(date +%s).conf"
    local config_path="/tmp/$config_name"
    
    cat > "$config_path" << EOF
[Interface]
PrivateKey = $private_key
Address = $address
DNS = $dns

[Peer]
PublicKey = $peer_public
Endpoint = $endpoint
AllowedIPs = $allowed_ips
PersistentKeepalive = 25
EOF
    
    chmod 600 "$config_path"
    echo ""
    echo -e "${GREEN}[â]${NC} Config saved: $config_path"
    read -p "Connect now? [y/N]: " connect_now
    
    if [[ "$connect_now" =~ ^[Yy]$ ]]; then
        local filename=$(basename "$config_path")
        local interface="${filename%.*}"
        local dest_path="/etc/wireguard/$filename"
        
        mkdir -p /etc/wireguard
        cp "$config_path" "$dest_path"
        chmod 600 "$dest_path"
        
        echo -e "${CYAN}[*]${NC} Connecting via WireGuard..."
        
        wg-quick down "$interface" 2>/dev/null
        sleep 1
        
        if wg-quick up "$interface" &>/dev/null; then
            sleep 2
            local pub_ip=$(curl -s ifconfig.me 2>/dev/null)
            echo -e "${GREEN}[â]${NC} Connected"
            echo -e "${GREEN}[â]${NC} Interface: $interface"
            if [[ -n "$pub_ip" ]]; then
                echo -e "${GREEN}[â]${NC} Public IP: $pub_ip"
            fi
            save_session "wireguard" "$dest_path" "" ""
        else
            echo -e "${RED}[!]${NC} Connection failed"
        fi
    fi
}

# Build OpenVPN config
build_ovpn_config() {
    echo ""
    echo -e "${CYAN}[*]${NC} OpenVPN Config Builder"
    echo ""
    
    read -p "Remote server (e.g., vpn.server.com): " remote_server
    read -p "Port (default: 1194): " port
    port=${port:-1194}
    read -p "Protocol [udp/tcp] (default: udp): " proto
    proto=${proto:-udp}
    
    local config_name="wir3g_$(date +%s).ovpn"
    local config_path="/tmp/$config_name"
    
    cat > "$config_path" << EOF
client
dev tun
proto $proto
remote $remote_server $port
resolv-retry infinite
nobind
persist-key
persist-tun
remote-cert-tls server
cipher AES-256-CBC
auth SHA256
verb 3
auth-user-pass
EOF
    
    chmod 600 "$config_path"
    echo ""
    echo -e "${GREEN}[â]${NC} Config saved: $config_path"
    echo -e "${YELLOW}[!]${NC} Note: You'll need to add CA cert and keys manually"
    read -p "Use this config now? [y/N]: " use_now
    
    if [[ "$use_now" =~ ^[Yy]$ ]]; then
        echo -e "${CYAN}[*]${NC} Config path: $config_path"
    fi
}

# Menu
show_menu() {
    echo -e "${CYAN}"
    echo "ââââââââââââââââââââââââââââââââââââââ"
    echo "â                                    â"
    echo "â            wir3G v${VERSION}             â"
    echo "â        oxbv1 | 0xb0rn3             â"
    echo "â                                    â"
    echo "ââââââââââââââââââââââââââââââââââââââ${NC}"
    echo ""
    echo -e "  ${GREEN}1${NC}) OpenVPN Connection"
    echo -e "  ${GREEN}2${NC}) WireGuard Connection"
    echo -e "  ${GREEN}3${NC}) Free VPN Servers (VPNGate & VPNBook)"
    echo -e "  ${YELLOW}4${NC}) Disconnect VPN"
    echo -e "  ${CYAN}5${NC}) Connection Status"
    echo -e "  ${CYAN}6${NC}) Build Config"
    echo -e "  ${CYAN}7${NC}) Install System-Wide"
    echo -e "  ${RED}8${NC}) Exit"
    echo ""
    read -p "  â " choice
    
    case $choice in
        1) connect_ovpn ;;
        2) connect_wg ;;
        3) fetch_vpngate_advanced ;;
        4) disconnect_vpn ;;
        5) check_status ;;
        6) build_config ;;
        7) install_system ;;
        8) exit 0 ;;
        *) echo -e "${RED}[!]${NC} Invalid option" && exit 1 ;;
    esac
}

# Main
clear
check_deps
echo ""
check_reconnect
show_menu

