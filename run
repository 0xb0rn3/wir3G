#!/usr/bin/env bash

# wir3G - VPN Connection Manager
# Dev: oxbv1 | 0xb0rn3
# Repo: https://github.com/0xb0rn3/wir3G.git

VERSION="0.1"
CONFIG_FILE="/etc/wir3G/config.json"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Check root
if [[ $EUID -ne 0 ]]; then
    echo -e "${RED}[!]${NC} Run with sudo"
    exit 1
fi

# Dependency check and install
check_deps() {
    local missing=()
    
    echo -e "${CYAN}[*]${NC} Checking dependencies..."
    
    # Check OpenVPN
    if ! command -v openvpn &>/dev/null; then
        missing+=("openvpn")
    fi
    
    # Check WireGuard
    if ! command -v wg &>/dev/null || ! command -v wg-quick &>/dev/null; then
        missing+=("wireguard-tools")
    fi
    
    # Check resolvconf
    if ! command -v resolvconf &>/dev/null; then
        missing+=("openresolv")
    fi
    
    # Install missing packages
    if [ ${#missing[@]} -gt 0 ]; then
        echo -e "${YELLOW}[!]${NC} Missing: ${missing[*]}"
        echo -e "${CYAN}[*]${NC} Installing dependencies..."
        
        if command -v apt &>/dev/null; then
            apt update -qq &>/dev/null
            apt install -y "${missing[@]}" &>/dev/null
        elif command -v dnf &>/dev/null; then
            dnf install -y "${missing[@]}" &>/dev/null
        elif command -v pacman &>/dev/null; then
            pacman -Sy --noconfirm "${missing[@]}" &>/dev/null
        else
            echo -e "${RED}[!]${NC} Package manager not supported"
            echo -e "${YELLOW}[!]${NC} Install manually: ${missing[*]}"
            exit 1
        fi
        
        echo -e "${GREEN}[✓]${NC} Dependencies installed"
    else
        echo -e "${GREEN}[✓]${NC} All dependencies present"
    fi
}

# Initialize config
init_config() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        mkdir -p /etc/wir3G
        echo '{"sessions":[]}' > "$CONFIG_FILE"
        chmod 600 "$CONFIG_FILE"
    fi
}

# Save session
save_session() {
    local vpn_type="$1"
    local config_path="$2"
    local username="$3"
    local password="$4"
    local timestamp=$(date +%s)
    
    init_config
    
    # Read existing config
    local sessions=$(cat "$CONFIG_FILE" | grep -o '"sessions":\[.*\]' | sed 's/"sessions"://')
    
    # Create new session entry
    local new_entry="{\"type\":\"$vpn_type\",\"config\":\"$config_path\",\"username\":\"$username\",\"password\":\"$password\",\"timestamp\":$timestamp}"
    
    # Add to sessions array
    if [[ "$sessions" == "[]" ]]; then
        sessions="[$new_entry]"
    else
        sessions=$(echo "$sessions" | sed "s/\]$/,$new_entry]/")
    fi
    
    # Write back
    echo "{\"sessions\":$sessions}" > "$CONFIG_FILE"
    chmod 600 "$CONFIG_FILE"
}

# Get last session
get_last_session() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        echo ""
        return
    fi
    
    # Extract last session from JSON
    local sessions=$(cat "$CONFIG_FILE" | grep -o '"sessions":\[.*\]')
    if [[ "$sessions" == *"[]"* ]] || [[ -z "$sessions" ]]; then
        echo ""
        return
    fi
    
    # Get last entry
    local last=$(echo "$sessions" | grep -o '{[^}]*}' | tail -n1)
    echo "$last"
}

# Parse session field
get_session_field() {
    local session="$1"
    local field="$2"
    echo "$session" | grep -o "\"$field\":\"[^\"]*\"" | cut -d'"' -f4
}

get_session_timestamp() {
    local session="$1"
    echo "$session" | grep -o '"timestamp":[0-9]*' | cut -d':' -f2
}

# Check if should reconnect
check_reconnect() {
    # Check if already connected
    local ovpn_running=$(pgrep -x openvpn > /dev/null && echo "yes" || echo "no")
    local wg_running=$(wg show interfaces 2>/dev/null)
    
    if [[ "$ovpn_running" == "yes" ]] || [[ -n "$wg_running" ]]; then
        echo -e "${GREEN}[✓]${NC} Active session detected"
        if [[ "$ovpn_running" == "yes" ]]; then
            echo -e "${GREEN}[✓]${NC} OpenVPN: Running"
        fi
        if [[ -n "$wg_running" ]]; then
            echo -e "${GREEN}[✓]${NC} WireGuard: Running ($wg_running)"
        fi
        local pub_ip=$(curl -s ifconfig.me 2>/dev/null)
        if [[ -n "$pub_ip" ]]; then
            echo -e "${GREEN}[✓]${NC} Public IP: $pub_ip"
        fi
        echo ""
        return
    fi
    
    local last_session=$(get_last_session)
    
    if [[ -z "$last_session" ]]; then
        return
    fi
    
    local timestamp=$(get_session_timestamp "$last_session")
    local vpn_type=$(get_session_field "$last_session" "type")
    local config_path=$(get_session_field "$last_session" "config")
    local current_time=$(date +%s)
    local time_diff=$((current_time - timestamp))
    
    # If last session was within 24 hours
    if [[ $time_diff -lt 86400 ]]; then
        local hours=$((time_diff / 3600))
        echo -e "${YELLOW}[?]${NC} Last session: $vpn_type ($hours hours ago)"
        read -p "Reconnect? [y/N]: " reconnect
        
        if [[ "$reconnect" =~ ^[Yy]$ ]]; then
            if [[ "$vpn_type" == "openvpn" ]]; then
                local username=$(get_session_field "$last_session" "username")
                local password=$(get_session_field "$last_session" "password")
                reconnect_ovpn "$config_path" "$username" "$password"
            else
                reconnect_wg "$config_path"
            fi
            exit 0
        fi
    fi
}

# Reconnect OpenVPN with saved creds
reconnect_ovpn() {
    local config_path="$1"
    local username="$2"
    local password="$3"
    
    if [[ ! -f "$config_path" ]]; then
        echo -e "${RED}[!]${NC} Previous config not found"
        return
    fi
    
    echo -e "${CYAN}[*]${NC} Reconnecting via OpenVPN..."
    
    pkill -9 openvpn 2>/dev/null
    sleep 1
    
    # Create auth file with credentials
    if [[ -n "$username" ]] && [[ -n "$password" ]]; then
        local auth_file="/tmp/ovpn_auth_$$"
        echo "$username" > "$auth_file"
        echo "$password" >> "$auth_file"
        chmod 600 "$auth_file"
        
        # Start with auth file
        openvpn --config "$config_path" --auth-user-pass "$auth_file" --daemon --log /tmp/ovpn.log
        sleep 3
        rm -f "$auth_file"
    else
        echo -e "${YELLOW}[!]${NC} No saved credentials - manual auth required"
        openvpn --config "$config_path" --daemon --log /tmp/ovpn.log
        sleep 3
    fi
    
    # Verify connection
    if pgrep -x openvpn > /dev/null; then
        sleep 2
        local pub_ip=$(curl -s ifconfig.me 2>/dev/null)
        echo -e "${GREEN}[✓]${NC} Connected"
        if [[ -n "$pub_ip" ]]; then
            echo -e "${GREEN}[✓]${NC} Public IP: $pub_ip"
        fi
    else
        echo -e "${RED}[!]${NC} Connection failed"
        if [[ -f /tmp/ovpn.log ]]; then
            echo -e "${YELLOW}[!]${NC} Check: cat /tmp/ovpn.log"
        fi
    fi
}

# Reconnect WireGuard
reconnect_wg() {
    local config_path="$1"
    
    if [[ ! -f "$config_path" ]]; then
        echo -e "${RED}[!]${NC} Previous config not found"
        return
    fi
    
    local filename=$(basename "$config_path")
    local interface="${filename%.*}"
    
    echo -e "${CYAN}[*]${NC} Reconnecting via WireGuard..."
    
    wg-quick down "$interface" 2>/dev/null
    sleep 1
    
    if wg-quick up "$interface" &>/dev/null; then
        sleep 2
        local pub_ip=$(curl -s ifconfig.me 2>/dev/null)
        echo -e "${GREEN}[✓]${NC} Connected"
        echo -e "${GREEN}[✓]${NC} Interface: $interface"
        if [[ -n "$pub_ip" ]]; then
            echo -e "${GREEN}[✓]${NC} Public IP: $pub_ip"
        fi
    else
        echo -e "${RED}[!]${NC} Connection failed"
    fi
}

# OpenVPN connection
connect_ovpn() {
    read -p "Config path: " config_path
    
    if [[ ! -f "$config_path" ]]; then
        echo -e "${RED}[!]${NC} Config file not found"
        exit 1
    fi
    
    # Check for saved credentials
    local last_session=$(get_last_session)
    local saved_user=""
    local saved_pass=""
    
    if [[ -n "$last_session" ]]; then
        local last_config=$(get_session_field "$last_session" "config")
        if [[ "$last_config" == "$config_path" ]]; then
            saved_user=$(get_session_field "$last_session" "username")
            saved_pass=$(get_session_field "$last_session" "password")
        fi
    fi
    
    # Ask for credentials or use saved
    local username="$saved_user"
    local password="$saved_pass"
    
    if [[ -z "$username" ]]; then
        read -p "Username (optional): " username
        if [[ -n "$username" ]]; then
            read -s -p "Password: " password
            echo ""
        fi
    else
        echo -e "${CYAN}[*]${NC} Using saved credentials for: $username"
    fi
    
    echo -e "${CYAN}[*]${NC} Connecting via OpenVPN..."
    
    # Kill existing instances
    pkill -9 openvpn 2>/dev/null
    sleep 1
    
    # Start OpenVPN with or without auth
    if [[ -n "$username" ]] && [[ -n "$password" ]]; then
        local auth_file="/tmp/ovpn_auth_$$"
        echo "$username" > "$auth_file"
        echo "$password" >> "$auth_file"
        chmod 600 "$auth_file"
        openvpn --config "$config_path" --auth-user-pass "$auth_file" --daemon --log /tmp/ovpn.log
        sleep 3
        rm -f "$auth_file"
    else
        openvpn --config "$config_path" --daemon --log /tmp/ovpn.log
        sleep 3
    fi
    
    # Verify connection
    if pgrep -x openvpn > /dev/null; then
        local pub_ip=$(curl -s ifconfig.me 2>/dev/null)
        echo -e "${GREEN}[✓]${NC} Connected"
        if [[ -n "$pub_ip" ]]; then
            echo -e "${GREEN}[✓]${NC} Public IP: $pub_ip"
        fi
        
        # Save session
        save_session "openvpn" "$config_path" "$username" "$password"
    else
        echo -e "${RED}[!]${NC} Connection failed"
        if [[ -f /tmp/ovpn.log ]]; then
            echo -e "${YELLOW}[!]${NC} Check: cat /tmp/ovpn.log"
        fi
        exit 1
    fi
}

# WireGuard connection
connect_wg() {
    read -p "Config path: " config_path
    
    if [[ ! -f "$config_path" ]]; then
        echo -e "${RED}[!]${NC} Config file not found"
        exit 1
    fi
    
    local filename=$(basename "$config_path")
    local interface="${filename%.*}"
    
    # Ensure .conf extension
    if [[ ! "$filename" =~ \.conf$ ]]; then
        filename="${interface}.conf"
    fi
    
    local dest_path="/etc/wireguard/$filename"
    
    echo -e "${CYAN}[*]${NC} Connecting via WireGuard..."
    
    # Create wireguard directory if not exists
    mkdir -p /etc/wireguard
    
    # Copy config
    if ! cp "$config_path" "$dest_path" 2>/dev/null; then
        echo -e "${RED}[!]${NC} Failed to copy config"
        exit 1
    fi
    chmod 600 "$dest_path"
    
    # Stop existing connection
    wg-quick down "$interface" 2>/dev/null
    systemctl stop "wg-quick@$interface" 2>/dev/null
    ip link delete "$interface" 2>/dev/null
    sleep 1
    
    # Start WireGuard using wg-quick directly
    if wg-quick up "$interface" 2>&1 | grep -q "error\|failed"; then
        echo -e "${RED}[!]${NC} WireGuard startup failed"
        echo -e "${YELLOW}[!]${NC} Check: journalctl -xeu wg-quick@$interface"
        exit 1
    fi
    
    sleep 2
    
    # Verify connection
    local has_link=$(ip link show "$interface" 2>/dev/null)
    local has_ip=$(ip -4 addr show "$interface" 2>/dev/null)
    
    if [[ -n "$has_link" ]] && [[ -n "$has_ip" ]]; then
        local pub_ip=$(curl -s ifconfig.me 2>/dev/null)
        echo -e "${GREEN}[✓]${NC} Connected"
        echo -e "${GREEN}[✓]${NC} Interface: $interface"
        if [[ -n "$pub_ip" ]]; then
            echo -e "${GREEN}[✓]${NC} Public IP: $pub_ip"
        fi
        
        # Save session
        save_session "wireguard" "$config_path" "" ""
    else
        wg-quick down "$interface" 2>/dev/null
        echo -e "${RED}[!]${NC} Connection failed"
        exit 1
    fi
}

# Disconnect
disconnect_vpn() {
    echo -e "${CYAN}[*]${NC} Disconnecting..."
    
    # Kill OpenVPN
    pkill -9 openvpn 2>/dev/null
    
    # Stop WireGuard
    for iface in $(wg show interfaces); do
        wg-quick down "$iface" 2>/dev/null
        systemctl stop "wg-quick@$iface" 2>/dev/null
        ip link delete "$iface" 2>/dev/null
    done
    
    sleep 1
    echo -e "${GREEN}[✓]${NC} Disconnected"
}

# Status check
check_status() {
    echo -e "${CYAN}[*]${NC} VPN Status:"
    
    # Check OpenVPN
    if pgrep -x openvpn > /dev/null; then
        echo -e "${GREEN}[✓]${NC} OpenVPN: Running"
    else
        echo -e "${YELLOW}[-]${NC} OpenVPN: Not running"
    fi
    
    # Check WireGuard
    local wg_ifaces=$(wg show interfaces 2>/dev/null)
    if [[ -n "$wg_ifaces" ]]; then
        echo -e "${GREEN}[✓]${NC} WireGuard: Running ($wg_ifaces)"
    else
        echo -e "${YELLOW}[-]${NC} WireGuard: Not running"
    fi
    
    # Show public IP
    local pub_ip=$(curl -s ifconfig.me 2>/dev/null)
    if [[ -n "$pub_ip" ]]; then
        echo -e "${CYAN}[*]${NC} Public IP: $pub_ip"
    fi
}

# Menu
show_menu() {
    echo -e "${CYAN}"
    echo "╔══════════════════════════════╗"
    echo "║         wir3G v$VERSION         ║"
    echo "║   oxbv1 | 0xb0rn3            ║"
    echo "╚══════════════════════════════╝${NC}"
    echo ""
    echo "1) OpenVPN"
    echo "2) WireGuard"
    echo "3) Disconnect"
    echo "4) Status"
    echo "5) Exit"
    echo ""
    read -p "Select: " choice
    
    case $choice in
        1) connect_ovpn ;;
        2) connect_wg ;;
        3) disconnect_vpn ;;
        4) check_status ;;
        5) exit 0 ;;
        *) echo -e "${RED}[!]${NC} Invalid option" && exit 1 ;;
    esac
}

# Main
clear
check_deps
echo ""
check_reconnect
show_menu
